{
  "name": "PlainText",
  "triggers": { "onCombat": "function combat(attacker, defendant, observers) {\n\n    var attackerStats = attacker.totalStats();\n    var defendantStats = defendant.totalStats();\n\n    var hitChance = 100 * ((80 + attackerStats[DEXTERITY]) / 160.0) *\n                          ((100 - defendantStats[DEXTERITY]) / 100.0);\n    var damage = 0;\n    if (byChance(hitChance, 100)) {\n        damage = randomInt(1, 20.0 * (attackerStats[STRENGTH] / 40.0) *\n                                     ((80 - defendantStats[ENDURANCE]) / 80.0));\n\n        defendant.hp -= damage;\n    }\n\n    var weaponCategory = (attacker.weapon ? attacker.weapon.category : \"\");\n    var secondaryWeaponCategory = (attacker.secondaryWeapon ? attacker.secondaryWeapon.category :\n                                                              \"\");\n\n    var weapon;\n    function attackerIsWieldingA(category) {\n        if (weaponCategory === category) {\n            return attacker.weapon;\n        } else if (secondaryWeaponCategory === category) {\n            return attacker.secondaryWeapon;\n        } else {\n            return null;\n        }\n    }\n\n    var beginnings = [];\n    var endings = [];\n\n    if (defendant.race && defendant.race.name === \"animal\" && defendant.weight < 50) {\n        beginnings.push(\"%a kicks toward %d\");\n\n        if (damage > 0) {\n            if ((weapon = attackerIsWieldingA(\"stick\")) ||\n                (weapon = attackerIsWieldingA(\"warhammer\"))) {\n                beginnings.push(\"%a smashes %pa \" + weapon.name + \" into %d\");\n                beginnings.push(\"%a bludgeons %d\");\n            }\n\n            endings.push(\"and %d jumps up as you hit %pd chest\");\n        } else {\n            beginnings.push(\"%a tries to hit %d\");\n\n            endings.push(\"but %d is too fast for %oa.\");\n        }\n    } else {\n        if (weaponCategory.isEmpty() && secondaryWeaponCategory.isEmpty()) {\n            beginnings.push(\"%a brings up a mighty punch\");\n            beginnings.push(\"%a kicks wildly at %d\");\n        } else {\n            if (!attackerIsWieldingA(\"warhammer\")) {\n                beginnings.push(\"%a thrusts at %d\");\n            }\n\n            if (attackerIsWieldingA(\"sword\")) {\n                beginnings.push(\"%a slashes at %d\");\n            } else if (attackerIsWieldingA(\"spear\")) {\n                beginnings.push(\"%a lashes out at %d\");\n            } else if (attackerIsWieldingA(\"dagger\")) {\n                beginnings.push(\"%a stabs at %d\");\n            }\n        }\n\n        if (damage > 0) {\n            if (weaponCategory.isEmpty() && secondaryWeaponCategory.isEmpty()) {\n                beginnings.push(\"%a deals %d a sweeping punch\");\n            } else {\n                if ((weapon = attackerIsWieldingA(\"stick\"))) {\n                    beginnings.push(\"%a smashes %pa \" + weapon.name + \" into %d\");\n                    beginnings.push(\"%a bludgeons %d\");\n                } else if ((weapon = attackerIsWieldingA(\"warhammer\"))) {\n                    beginnings.push(\"%a smashes %pa \" + weapon.name + \" into %d\");\n                    beginnings.push(\"%a bludgeons %d\");\n                    beginnings.push(\"%a crushes %d with %pa \" + weapon.name);\n                }\n            }\n\n            if (attacker.height > defendant.height - 100) {\n                endings.push(\"and hits %od in the face\");\n                endings.push(\"and violently smashes %pd nose\");\n                endings.push(\"hitting %od on the jaw\");\n            }\n\n            endings.push(\"and hits %od in the stomach, causing %od to double over\");\n            endings.push(\"and hits %od in the flank\");\n        } else {\n            if (weaponCategory.isEmpty() && secondaryWeaponCategory.isEmpty()) {\n                beginnings.push(\"%a tries to hit %d\");\n            } else {\n                beginnings.push(\"%a tries to hit %d with %pa %w\");\n            }\n\n            endings.push(\"but %d blocks the blow\");\n            endings.push(\"but hits nothing but air\");\n            endings.push(\"but fails to hurt %od\");\n        }\n    }\n\n    var beginning = beginnings.randomElement();\n    var ending = endings.randomElement();\n\n    var message = (ending.startsWith(\"and\") ? beginning + \" \" + ending : beginning + \", \" + ending);\n\n    function secondPersonIndicativeOf(verb) {\n        if (verb.endsWith(\"ies\")) {\n            return verb.substr(0, verb.length - 3) + \"y\";\n        } else if (verb.endsWith(\"es\")) {\n            return verb.substr(0, verb.length - 2);\n        } else {\n            return verb.substr(0, verb.length - 1);\n        }\n    }\n\n    var verb = beginning.split(\" \")[1];\n    var secondPersonIndicative = secondPersonIndicativeOf(verb);\n\n    var secondVerb = undefined;\n    var secondVerbPerson = \"\";\n    var endingWords = ending.split(\" \");\n    if (endingWords[1].endsWith(\"s\")) {\n        secondVerb = endingWords[1];\n        secondVerbPerson = \"attacker\";\n    } else if (endingWords[2].endsWith(\"s\")) {\n        secondVerb = endingWords[2];\n        secondVerbPerson = (endingWords[1] == \"%d\" ? \"defendant\" : \"attacker\");\n    }\n    var secondSecondPersonIndicative = secondVerb ? secondPersonIndicativeOf(secondVerb) : \"\";\n\n    var area = defendant.currentRoom;\n\n    var attackerDefiniteName = attacker.definiteName(area.npcs);\n    var defendantDefiniteName = defendant.definiteName(area.npcs);\n\n    if (attacker.isPlayer()) {\n        var attackerMessage = message.replace(verb, secondPersonIndicative);\n        if (secondVerbPerson === \"attacker\") {\n            attackerMessage = attackerMessage.replace(secondVerb, secondSecondPersonIndicative);\n        }\n        attackerMessage = attackerMessage.replace(\"%a\", \"you\");\n        attackerMessage = attackerMessage.replace(\"%oa\", \"you\");\n        attackerMessage = attackerMessage.replace(\"%pa\", \"your\");\n        if (attackerMessage.contains(\"%d\")) {\n            attackerMessage = attackerMessage.replace(\"%d\", defendantDefiniteName);\n            attackerMessage = attackerMessage.replaceAll(\"%d\", defendant.subjectPronoun);\n            attackerMessage = attackerMessage.replaceAll(\"%od\", defendant.objectPronoun);\n            attackerMessage = attackerMessage.replaceAll(\"%pd\", defendant.possessiveAdjective);\n        } else {\n            attackerMessage = attackerMessage.replace(\"%od\", defendantDefiniteName);\n            attackerMessage = attackerMessage.replaceAll(\"%od\", defendant.objectPronoun);\n            attackerMessage = attackerMessage.replaceAll(\"%pd\", defendantDefiniteName + \"'s\");\n        }\n        attackerMessage += (damage > 0 ? \", dealing \" + damage + \" damage.\" : \".\");\n\n        attacker.send(attackerMessage.capitalized(), Color.Teal);\n    }\n\n    if (defendant.isPlayer()) {\n        var defendantMessage = message;\n        if (secondVerbPerson === \"defendant\") {\n            defendantMessage = defendantMessage.replace(secondVerb, secondSecondPersonIndicative);\n        }\n        defendantMessage = defendantMessage.replace(\"%a\", attackerDefiniteName);\n        defendantMessage = defendantMessage.replace(\"%oa\", attacker.objectPronoun);\n        defendantMessage = defendantMessage.replace(\"%pa\", attacker.possessiveAdjective);\n        defendantMessage = defendantMessage.replaceAll(\"%d\", \"you\");\n        defendantMessage = defendantMessage.replaceAll(\"%od\", \"you\");\n        defendantMessage = defendantMessage.replaceAll(\"%pd\", \"your\");\n        defendantMessage += (damage > 0 ? \", dealing \" + damage + \" damage.\" : \".\");\n\n        defendant.send(defendantMessage.capitalized(), damage > 0 ? Color.Red : Color.Green);\n    }\n\n    if (!observers.isEmpty()) {\n        var observersMessage = message + \".\";\n        observersMessage = observersMessage.replace(\"%a\", attackerDefiniteName);\n        observersMessage = observersMessage.replace(\"%oa\", attacker.objectPronoun);\n        observersMessage = observersMessage.replace(\"%pa\", attacker.possessiveAdjective);\n        if (observersMessage.contains(\"%d\")) {\n            observersMessage = observersMessage.replace(\"%d\", defendantDefiniteName);\n            observersMessage = observersMessage.replaceAll(\"%d\", defendant.subjectPronoun);\n            observersMessage = observersMessage.replaceAll(\"%od\", defendant.objectPronoun);\n            observersMessage = observersMessage.replaceAll(\"%pd\", defendant.possessiveAdjective);\n        } else {\n            observersMessage = observersMessage.replaceAll(\"%od\", defendantDefiniteName);\n            observersMessage = observersMessage.replaceAll(\"%pd\", defendantDefiniteName + \"'s\");\n        }\n\n        observers.send(observersMessage.capitalized(), Color.Teal);\n    }\n\n    attacker.stun(4000 - (25 * attackerStats[DEXTERITY]));\n}" },
  "dateTime": 66397968000000
}
